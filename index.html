<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¹¼ç¨šåœ’ç”³è«‹è¿½è¹¤ Caleb's Family</title>
  <style>
    :root{--bg:#0b1020;--card:#11162a;--muted:#8aa0b9;--text:#eaf2ff;--accent:#4da3ff;--ok:#27c084;--warn:#ffc857;--danger:#ff6a6a;--line:#1e2742}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1428);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:24px}
    .header{display:flex;justify-content:space-between;gap:16px;align-items:flex-end;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(22px,3.2vw,32px);letter-spacing:.3px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .control{background:var(--card);border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:flex;align-items:center;gap:8px}
    input[type="text"]{background:transparent;border:none;outline:none;color:var(--text);min-width:220px}
    .btn{cursor:pointer;background:var(--accent);color:#001; border:none;padding:10px 14px;border-radius:12px;font-weight:600}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--line)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:4px;overflow:hidden;margin-top:16px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:rgba(17,22,42,.9);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--line);text-align:left;font-size:14px;padding:12px}
    tbody td{border-top:1px solid var(--line);padding:12px;vertical-align:top}
    tbody tr:hover{background:rgba(77,163,255,.06)}
    .name{font-weight:650}
    .status-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:13px}
    .status-ok{background:rgba(39,192,132,.15);border-color:rgba(39,192,132,.35)}
    .status-empty{background:rgba(138,160,185,.08)}
    .check{accent-color:var(--ok);width:18px;height:18px}
    .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .note{color:var(--muted);font-size:13px}
    .clock{white-space:nowrap}
    footer{margin:18px 0;color:var(--muted);font-size:13px}

    /* === åˆ†ç´šæé†’ï¼ˆ14 / 7 / 3 å¤© / ä»Šæ—¥ / å·²éæœŸï¼‰ === */
    .tier{position:relative}
    .tier::after{content:attr(data-due-label);margin-left:8px;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .due-14{background:rgba(255,200,87,.12)}
    .due-14::after{background:rgba(255,200,87,.25);color:#2b1e00}
    .due-7{background:rgba(255,160,60,.14)}
    .due-7::after{background:rgba(255,160,60,.33);color:#2b1200}
    .due-3{background:rgba(255,106,106,.16)}
    .due-3::after{background:rgba(255,106,106,.35);color:#330202}
    .due-today{background:rgba(77,163,255,.18)}
    .due-today::after{background:rgba(77,163,255,.35);color:#001933}
    .due-over{background:rgba(180,60,60,.18)}
    .due-over::after{background:rgba(180,60,60,.38);color:#2b0000}

    /* æ¥å—æœŸå…§ï¼ˆâ€¦è‡³â€¦ ä¸”ä»Šå¤©åœ¨ç¯„åœå…§ï¼‰ */
    .within{position:relative;background:rgba(77,163,255,.14)}
    .within::after{content:'æ¥å—æœŸå…§';margin-left:8px;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(77,163,255,.35);color:#001933}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Caleb's family</h1>
        <span class="badge">æœ€å¾Œæ›´æ–°ï¼š<span id="updated"></span></span>
      </div>
      <div class="badge clock">é¦™æ¸¯æ™‚é–“ (GMT+8)ï¼š<span id="hkTime"></span></div>
    </div>

    <div class="controls">
      <label class="control" title="æœå°‹å­¸æ ¡æˆ–æ—¥æœŸ">
        ğŸ” <input id="q" type="text" placeholder="æœå°‹å­¸æ ¡ / æ—¥æœŸ / é—œéµå­—" />
      </label>
      <label class="control">
        <input id="onlyChecked" type="checkbox" /> åªé¡¯ç¤º âœ… å·²è™•ç†
      </label>
      <button class="btn" id="exportCsv">åŒ¯å‡º CSV</button>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:30%">å¹¼ç¨šåœ’</th>
            <th style="width:30%">æ¥å—ç”³è«‹æ—¥æœŸ / å‚™è¨»</th>
            <th style="width:20%">å­¸è²»</th>
            <th style="width:20%">Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer> Caleb's family </footer>
  </div>

<script>
/* ------------------------------- Data --------------------------------- */
const rows = [
  { id: 0, name: "åº·å‚‘ä¸­è‹±æ–‡å¹¼ç¨šåœ’", date: "2025å¹´6æœˆ9æ—¥è‡³2025å¹´9æœˆ15æ—¥ä¸‹åˆ5æ™‚æ­£", note: "", checked: true },
  { id: 1, name: "ç¶ æ¥Šå¹¼ç¨šåœ’æš¨å¹¼å…’åœ’", date: "2025å¹´9æœˆ13æ—¥è‡³9æœˆ20æ—¥ï¼ˆéƒµå¯„ï¼‰", note: "", checked: false },
  { id: 2, name: "å¿ƒæ€¡å¤©åœ°åœ‹éš›å¹¼å…’åœ’æš¨å¹¼ç¨š", date: "2025å¹´8æœˆè‡³10æœˆ12æ—¥ï¼ˆéƒµå¯„ï¼‰", note: "14/8âœ…", checked: true },
  { id: 3, name: "ç¶­å¤šåˆ©äºï¼ˆæµ·ä¹‹æˆ€ï¼‰åœ‹éš›å¹¼å…’åœ’", date: "2025å¹´9æœˆ15æ—¥è‡³2025å¹´12æœˆ15æ—¥ï¼ˆæ˜ŸæœŸä¸€ï¼‰ä¸‹åˆ5æ™‚", note: "", checked: false },
  { id: 4, name: "é’è¡£å­¸ä¹‹åœ’", date: "å°‡æ–¼2026å¹´1æœˆå…¬ä½ˆ", note: "", checked: false },
  { id: 5, name: "è¿¦å—å¹¼ç¨šåœ’(ä¹é¾å¡˜)", date: "2025å¹´9æœˆ15æ—¥è‡³10æœˆ19æ—¥", note: "", checked: false },
  { id: 6, name: "è¿¦å—å¹¼ç¨šåœ’ï¼ˆæµ·æ¿±èŠ±åœ’)", date: "2025å¹´9æœˆ15æ—¥è‡³10æœˆ19æ—¥", note: "", checked: false },
  { id: 7, name: "è¿¦å—å¹¼ç¨šåœ’(çª©æ‰“è€é“)", date: "", note: "", checked: false },
  { id: 8, name: "St Catherine åœ‹éš›è‹±æ–‡å¹¼ç¨šåœ’", date: "", note: "", checked: false },
  { id: 9, name: "å¾·èƒå¹¼ç¨šåœ’", date: "", note: "4/9âœ…", checked: true },
  { id: 10, name: "æ˜æ…§åœ‹éš›å¹¼ç¨šåœ’", date: "", note: "12/8âœ…", checked: true },
  { id:11, name: "å“æ€è‹±æ–‡å­¸æ ¡æš¨å¹¼ç¨šåœ’", date: "2025å¹´10æœˆ27æ—¥è‡³11æœˆ1æ—¥", note: "", checked: false },
  { id:12, name: "åŠé³´å¹¼ç¨šåœ’", date: "2026å¹´1æœˆ7æ—¥ä¸Šåˆ9æ™‚è‡³1æœˆ14æ—¥ä¸‹åˆ5æ™‚", note: "", checked: false },
  { id:13, name: "é›…å£«åœ–åœ‹éš›å¹¼ç¨šåœ’", date: "", note: "3/9âœ…", checked: true },
  { id:14, name: "å•Ÿæ€å¹¼ç¨šåœ’ï¼ˆé’è¡£ï¼‰", date: "", note: "", checked: false },
];

/* --------------------------- LocalStorage ------------------------------ */
// ç‹€æ…‹ã€åç¨±ã€å‚™è¨»ã€æ—¥æœŸã€å­¸è²»åˆ†é–‹å„²å­˜ï¼Œä»¥ç©©å®š ID ç‚ºéµ
const STATUS_KEY = "kinder-status:v1";
const NAMES_KEY  = "kinder-names:v1";
const NOTES_KEY  = "kinder-notes:v1";
const DATES_KEY  = "kinder-dates:v1";
const TUITION_KEY= "kinder-tuition:v1";

const savedStatus   = JSON.parse(localStorage.getItem(STATUS_KEY) || "{}");
const savedNames    = JSON.parse(localStorage.getItem(NAMES_KEY)  || "{}");
const savedNotes    = JSON.parse(localStorage.getItem(NOTES_KEY)  || "{}");
const savedDates    = JSON.parse(localStorage.getItem(DATES_KEY)  || "{}");
const savedTuition  = JSON.parse(localStorage.getItem(TUITION_KEY)|| "{}");

const getStatus = (id, fallback)=> (id in savedStatus) ? savedStatus[id] : fallback;
const setStatus = (id, val)=>{ savedStatus[id] = !!val; localStorage.setItem(STATUS_KEY, JSON.stringify(savedStatus)); };

const getName = (id, fallback)=> savedNames[id] ?? fallback;
const setName = (id, val)=>{ savedNames[id] = (val||""); localStorage.setItem(NAMES_KEY, JSON.stringify(savedNames)); };

const getNote = (id, fallback)=> savedNotes[id] ?? (fallback||"");
const setNote = (id, val)=>{ savedNotes[id] = (val||""); localStorage.setItem(NOTES_KEY, JSON.stringify(savedNotes)); };

const getDate = (id, fallback)=> savedDates[id] ?? (fallback||"");
const setDate = (id, val)=>{ savedDates[id] = (val||""); localStorage.setItem(DATES_KEY, JSON.stringify(savedDates)); };

const getTuition = (id, fallback)=> savedTuition[id] ?? (fallback||"");
const setTuition = (id, val)=>{ savedTuition[id] = (val||""); localStorage.setItem(TUITION_KEY, JSON.stringify(savedTuition)); };

function clearSaved(){
  localStorage.removeItem(STATUS_KEY);
  localStorage.removeItem(NAMES_KEY);
  localStorage.removeItem(NOTES_KEY);
  localStorage.removeItem(DATES_KEY);
  localStorage.removeItem(TUITION_KEY);
  location.reload();
}

/* ------------------------- Hong Kong Clock ---------------------------- */
function tickHK(){
  const fmt = new Intl.DateTimeFormat('zh-Hant-HK', {
    timeZone:'Asia/Hong_Kong', hour12:false,
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
  document.getElementById('hkTime').textContent = fmt.format(new Date());
}
setInterval(tickHK, 1000); tickHK();

/* --------------------- Date Parsing & Highlight ----------------------- */
function parseRange(text){
  if(!text) return null;
  const t = String(text).replace(/ï¼ˆ/g,'(').replace(/ï¼‰/g,')');
  if(t.includes('è‡³')){
    const [L,R] = t.split('è‡³');
    const ly = (L.match(/(\d{4})å¹´/)||[])[1] || new Date().getFullYear();
    const s = partToDate(L, ly);
    let   e = partToDate(R, ly);
    if(s && e && e < s) e = new Date(s.getFullYear()+1, e.getMonth(), e.getDate());
    return (s && e) ? {start:s, end:e} : null;
  }
  const m = t.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
  if(m){ const dt = new Date(+m[1], +m[2]-1, +m[3]); return {start:dt, end:dt}; }
  return null;
}
function partToDate(part, fallbackYear){
  const y = (part.match(/(\d{4})å¹´/)||[])[1] || fallbackYear || new Date().getFullYear();
  const m = (part.match(/(\d{1,2})æœˆ/)||[])[1];
  const d = (part.match(/(\d{1,2})æ—¥/)||[])[1];
  if(!m||!d) return null;
  return new Date(+y, +m-1, +d);
}
function hkToday(){
  const nowHK = new Date(new Date().toLocaleString('en-US', { timeZone:'Asia/Hong_Kong' }));
  return new Date(nowHK.getFullYear(), nowHK.getMonth(), nowHK.getDate());
}
function inRangeToday(range){
  if(!range) return false;
  const today = hkToday();
  const s = new Date(range.start.getFullYear(), range.start.getMonth(), range.start.getDate());
  const e = new Date(range.end.getFullYear(), range.end.getMonth(), range.end.getDate());
  return today >= s && today <= e;
}
function parseTimePart(str){
  const m = str.match(/(ä¸Šåˆ|ä¸‹åˆ)?\s*(\d{1,2})\s*æ™‚/);
  if(!m) return 17;
  let h = +m[2]; if(m[1]==='ä¸‹åˆ' && h<12) h+=12; if(m[1]==='ä¸Šåˆ' && h===12) h=0; return h;
}
function parseDeadline(text){
  if(!text) return null;
  const res = [];
  const hour = parseTimePart(text);
  const now = new Date();

  [...text.matchAll(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/g)]
    .forEach(m => res.push(new Date(+m[1], +m[2]-1, +m[3], hour)));
  [...text.matchAll(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g)]
    .forEach(m => {
      let y = now.getFullYear();
      let dt = new Date(y, +m[1]-1, +m[2], hour);
      if(dt < now) dt = new Date(y+1, +m[1]-1, +m[2], hour);
      res.push(dt);
    });
  [...text.matchAll(/\b(\d{1,2})\/(\d{1,2})\b/g)]
    .forEach(m => res.push(new Date(now.getFullYear(), +m[2]-1, +m[1], 17)));

  if(!res.length) return null;
  res.sort((a,b)=>a-b);
  return res[res.length-1];
}
function classifyTier(dt){
  if(!dt) return {cls:'', label:''};
  const today = hkToday();
  const end = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
  const diffDays = Math.ceil((end - today) / 86400000);
  if(diffDays < 0)  return {cls:'due-over',  label:'å·²éæœŸ'};
  if(diffDays === 0) return {cls:'due-today', label:'ä»Šæ—¥æˆªæ­¢'};
  if(diffDays <= 3)  return {cls:'due-3',     label:`${diffDays}æ—¥å…§æˆªæ­¢`};
  if(diffDays <= 7)  return {cls:'due-7',     label:`${diffDays}æ—¥å…§æˆªæ­¢`};
  if(diffDays <= 14) return {cls:'due-14',    label:`${diffDays}æ—¥å…§æˆªæ­¢`};
  return {cls:'', label:''};
}

/* ------------------------------- Render -------------------------------- */
const tbody = document.querySelector('#tbl tbody');

function render(){
  const q = document.querySelector('#q').value.trim().toLowerCase();
  const onlyChecked = document.querySelector('#onlyChecked').checked;
  tbody.innerHTML = '';

  rows.forEach(r => {
    const id = r.id;
    const displayName = getName(id, r.name);
    const displayNote = getNote(id, r.note || "");
    const displayDate = getDate(id, r.date || "");
    const displayTuition = getTuition(id, r.tuition || "");
    const isChecked = getStatus(id, r.checked);

    const textBlob = (displayName + ' ' + (displayDate||'') + ' ' + displayNote + ' ' + displayTuition).toLowerCase();
    if(q && !textBlob.includes(q)) return;
    if(onlyChecked && !isChecked) return;

    const tr = document.createElement('tr');

    // col 1: åç¨±ï¼ˆå¯ç·¨è¼¯ï¼‰ + å‚™è¨»ï¼ˆå¯ç·¨è¼¯ï¼‰
    const td1 = document.createElement('td');
    td1.innerHTML = `
      <div class="name" data-id="${id}" contenteditable="true" spellcheck="false" title="é»æ“Šå¯æ”¹å">${displayName}</div>
      <div class="note">å‚™è¨»ï¼š<span class="note-text" data-id="${id}" contenteditable="true" spellcheck="false" title="é»æ“Šå¯ç·¨è¼¯å‚™è¨»">${displayNote}</span></div>
    `;

    const nameEl = td1.querySelector('.name');
    nameEl.addEventListener('blur', ()=>{
      const newName = (nameEl.textContent || '').trim() || r.name;
      setName(id, newName);
      render();
    });

    const noteEl = td1.querySelector('.note-text');
    noteEl.addEventListener('blur', ()=>{
      const newNote = (noteEl.textContent || '').trim();
      setNote(id, newNote);
      render();
    });

    // col 2: æ—¥æœŸï¼ˆå¯ç·¨è¼¯ï¼›å«é«˜äº®ï¼‰
    const td2 = document.createElement('td');
    const combinedForDeadline = (displayDate||'') + ' ' + displayNote; // å‚™è¨»ä¹Ÿå¯èƒ½å«æ—¥æœŸ
    const deadline = parseDeadline(combinedForDeadline);
    const {cls,label} = classifyTier(deadline);
    if(cls){ td2.classList.add('tier', cls); td2.setAttribute('data-due-label', label); }
    const range = parseRange(displayDate);
    if(inRangeToday(range)){
      td2.classList.remove('tier','due-14','due-7','due-3','due-today','due-over');
      td2.removeAttribute('data-due-label');
      td2.classList.add('within');
    }
    td2.innerHTML = `<span class="date-text" data-id="${id}" contenteditable="true" spellcheck="false" title="é»æ“Šå¯ç·¨è¼¯æ—¥æœŸ">${displayDate || 'â€”'}</span>`;
    const dateEl = td2.querySelector('.date-text');
    dateEl.addEventListener('blur', ()=>{
      const newDate = (dateEl.textContent || '').trim();
      setDate(id, newDate);
      render();
    });

    // col 3: å­¸è²»ï¼ˆå¯ç·¨è¼¯ï¼‰
    const tdTuition = document.createElement('td');
    tdTuition.innerHTML = `<span class="tuition-text" data-id="${id}" contenteditable="true" spellcheck="false" title="é»æ“Šå¯ç·¨è¼¯å­¸è²»ï¼ˆä¾‹å¦‚ï¼š$6,500 / æœˆï¼‰">${displayTuition || ''}</span>`;
    const tuitionEl = tdTuition.querySelector('.tuition-text');
    tuitionEl.addEventListener('blur', ()=>{
      const newTuition = (tuitionEl.textContent || '').trim();
      setTuition(id, newTuition);
      // ä¸é‡æ•´ä¹Ÿå¯ï¼Œä½†ç‚ºä¸€è‡´æ€§æ²¿ç”¨ render() æ›´æ–°
      render();
    });

    // col 4: å‹¾é¸ç‹€æ…‹
    const td3 = document.createElement('td');
    const labelEl = document.createElement('label');
    labelEl.className = 'status-pill ' + (isChecked ? 'status-ok' : 'status-empty');
    const chk = document.createElement('input');
    chk.type = 'checkbox'; chk.className = 'check'; chk.checked = isChecked;
    chk.addEventListener('change', e => {
      setStatus(id, e.target.checked);
      labelEl.className = 'status-pill ' + (e.target.checked ? 'status-ok' : 'status-empty');
      textNode.textContent = e.target.checked ? 'âœ… å·²è™•ç†' : 'å¾…è™•ç†';
    });
    const textNode = document.createElement('span');
    textNode.textContent = isChecked ? 'âœ… å·²è™•ç†' : 'å¾…è™•ç†';
    labelEl.appendChild(chk); labelEl.appendChild(textNode);
    td3.appendChild(labelEl);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(tdTuition); tr.appendChild(td3);
    tbody.appendChild(tr);
  });
}

render();

/* ------------------------------ Controls ------------------------------- */
document.querySelector('#q').addEventListener('input', render);
document.querySelector('#onlyChecked').addEventListener('change', render);
document.querySelector('#clearChecks').addEventListener('click', clearSaved);

document.getElementById('updated').textContent = new Date().toLocaleString();

/* ------------------------------- Export -------------------------------- */
function exportCsv(){
  const headers = ['å¹¼ç¨šåœ’','æ¥å—ç”³è«‹æ—¥æœŸ / å‚™è¨»','å­¸è²»','Status'];
  const visible = Array.from(tbody.querySelectorAll('tr')).map(tr => {
    const name = tr.querySelector('.name')?.textContent.trim() || '';
    const note = tr.querySelector('.note-text')?.textContent.trim() || '';
    const date = tr.querySelector('.date-text')?.textContent.trim() || '';
    const tuition = tr.querySelector('.tuition-text')?.textContent.trim() || '';
    const status = tr.querySelector('input[type="checkbox"]')?.checked ? 'å·²è™•ç†' : 'å¾…è™•ç†';
    const dateAndNote = (date || '') + (note? ` | å‚™è¨»:${note}`:'');
    return [name, dateAndNote, tuition, status];
  });
  const lines = [headers, ...visible]
    .map(row => row.map(x => '"' + (x || '').replaceAll('"','""') + '"').join(','))
    .join('\n');
  const blob = new Blob([lines], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'å¹¼ç¨šåœ’ç”³è«‹è¿½è¹¤.csv';
  a.click();
}

document.getElementById('exportCsv').addEventListener('click', exportCsv);
</script>
</body>
</html>
