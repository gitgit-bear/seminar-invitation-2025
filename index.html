<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¹¼ç¨šåœ’ç”³è«‹è¿½è¹¤ | Kindergarten Application Index</title>
  <style>
    :root{--bg:#0b1020;--card:#11162a;--muted:#8aa0b9;--text:#eaf2ff;--accent:#4da3ff;--ok:#27c084;--warn:#ffc857;--danger:#ff6a6a;--line:#1e2742}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1428);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:24px}
    .header{display:flex;gap:16px;align-items:end;flex-wrap:wrap;justify-content:space-between}
    h1{margin:0;font-size:clamp(22px,3.2vw,32px);letter-spacing:.3px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .control{background:var(--card);border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:flex;align-items:center;gap:8px}
    input[type="text"]{background:transparent;border:none;outline:none;color:var(--text);min-width:220px}
    .btn{cursor:pointer;background:var(--accent);color:#001; border:none;padding:10px 14px;border-radius:12px;font-weight:600}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--line)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:4px;overflow:hidden;margin-top:16px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:rgba(17,22,42,.9);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--line);text-align:left;font-size:14px;padding:12px}
    tbody td{border-top:1px solid var(--line);padding:12px;vertical-align:top}
    tbody tr:hover{background:rgba(77,163,255,.06)}
    .name{font-weight:650}
    .status-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:13px}
    .status-ok{background:rgba(39,192,132,.15);border-color:rgba(39,192,132,.35)}
    .status-empty{background:rgba(138,160,185,.08)}
    .check{accent-color:var(--ok);width:18px;height:18px}
    .hint{font-size:12px}
    .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .note{color:var(--muted);font-size:13px}
    footer{margin:18px 0;color:var(--muted);font-size:13px}

    /* highlight */
    .within{background:rgba(77,163,255,.2)}
    .due-over{background:rgba(255,106,106,.16)}
    .due-today{background:rgba(77,163,255,.18)}
    .due-soon{background:rgba(255,200,87,.12)}
  
    /* === åˆ†ç´šæé†’ï¼ˆ14 / 7 / 3 å¤© / ä»Šæ—¥ / å·²éæœŸï¼‰ === */
    .tier{position:relative}
    .tier::after{content:attr(data-due-label);margin-left:8px;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .due-14{background:rgba(255,200,87,.12)}
    .due-14::after{background:rgba(255,200,87,.25);color:#2b1e00}
    .due-7{background:rgba(255,160,60,.14)}
    .due-7::after{background:rgba(255,160,60,.33);color:#2b1200}
    .due-3{background:rgba(255,106,106,.16)}
    .due-3::after{background:rgba(255,106,106,.35);color:#330202}
    .due-today{background:rgba(77,163,255,.18)}
    .due-today::after{background:rgba(77,163,255,.35);color:#001933}
    .due-over{background:rgba(180,60,60,.18)}
    .due-over::after{background:rgba(180,60,60,.38);color:#2b0000}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>å¹¼ç¨šåœ’ç”³è«‹è¿½è¹¤è¡¨ <span class="muted">(Kindergarten Application Index)</span></h1>
      <div>
        <span class="badge">é¦™æ¸¯æ™‚é–“ (GMT+8)ï¼š<span id="hkclock"></span></span>
        <span class="badge">æœ€å¾Œæ›´æ–°ï¼š<span id="updated"></span></span>
      </div>
    </div>

    <div class="controls">
      <label class="control" title="æœå°‹å­¸æ ¡æˆ–æ—¥æœŸ">
        ğŸ” <input id="q" type="text" placeholder="æœå°‹å­¸æ ¡ / æ—¥æœŸ / é—œéµå­—" />
      </label>
      <label class="control">
        <input id="onlyChecked" type="checkbox" /> åªé¡¯ç¤º âœ… å·²è™•ç†
      </label>
      <button class="btn" id="exportCsv">åŒ¯å‡º CSV</button>
      <button class="btn secondary" id="clearChecks">æ¸…é™¤æœ¬æ©Ÿ âœ… è¨˜éŒ„</button>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:44%">å¹¼ç¨šåœ’</th>
            <th style="width:42%">æ¥å—ç”³è«‹æ—¥æœŸ / å‚™è¨»</th>
            <th style="width:14%">Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>æç¤ºï¼šâœ”ï¸ åˆ‡æ› Status æœƒå„²å­˜æ–¼ç€è¦½å™¨ <span class="badge">localStorage</span>ï¼Œä¸æœƒä¸Šå‚³è³‡æ–™ã€‚</footer>
  </div>

<script>
// ---- Data --------------------------------------------------------------
let rows = [
  { name: "åº·å‚‘ä¸­è‹±æ–‡å¹¼ç¨šåœ’", date: "2025å¹´6æœˆ9æ—¥è‡³2025å¹´9æœˆ15æ—¥ä¸‹åˆ5æ™‚æ­£", note: "", checked: true },
  { name: "ç¶ æ¥Šå¹¼ç¨šåœ’æš¨å¹¼å…’åœ’", date: "2025å¹´9æœˆ13æ—¥è‡³9æœˆ20æ—¥ï¼ˆéƒµå¯„ï¼‰", note: "", checked: false },
  { name: "å¿ƒæ€¡å¤©åœ°åœ‹éš›å¹¼å…’åœ’æš¨å¹¼ç¨š", date: "2025å¹´8æœˆè‡³10æœˆ12æ—¥ï¼ˆéƒµå¯„ï¼‰", note: "14/8âœ…", checked: true },
  { name: "ç¶­å¤šåˆ©äºï¼ˆæµ·ä¹‹æˆ€ï¼‰åœ‹éš›å¹¼å…’åœ’", date: "2025å¹´9æœˆ15æ—¥è‡³2025å¹´12æœˆ15æ—¥ï¼ˆæ˜ŸæœŸä¸€ï¼‰ä¸‹åˆ5æ™‚", note: "", checked: false },
  { name: "é’è¡£å­¸ä¹‹åœ’", date: "å°‡æ–¼2026å¹´1æœˆå…¬ä½ˆ", note: "", checked: false },
  { name: "ä¹é¾å¡˜è¿¦å—", date: "2025å¹´9æœˆ15æ—¥è‡³10æœˆ19æ—¥", note: "", checked: false },
  { name: "è¿¦å—å¹¼ç¨šåœ’ï¼ˆæµ·æ¿±èŠ±åœ’ï¼‰", date: "2025å¹´9æœˆ15æ—¥è‡³10æœˆ19æ—¥", note: "", checked: false },
  { name: "St Catherine åœ‹éš›è‹±æ–‡å¹¼ç¨šåœ’", date: "", note: "", checked: false },
  { name: "å¾·èƒ", date: "", note: "4/9âœ…", checked: true },
  { name: "æ˜æ…§åœ‹éš›å¹¼ç¨šåœ’", date: "", note: "12/8âœ…", checked: true },
  { name: "å“æ€è‹±æ–‡å­¸æ ¡æš¨å¹¼ç¨šåœ’", date: "2025å¹´10æœˆ27æ—¥è‡³11æœˆ1æ—¥", note: "", checked: false },
  { name: "åŠé³´å¹¼ç¨šåœ’", date: "2026å¹´1æœˆ7æ—¥ä¸Šåˆ9æ™‚è‡³1æœˆ14æ—¥ä¸‹åˆ5æ™‚", note: "", checked: false },
  { name: "é›…å£«åœ–åœ‹éš›å¹¼ç¨šåœ’", date: "", note: "3/9âœ…", checked: true },
  { name: "å•Ÿæ€å¹¼ç¨šåœ’ï¼ˆé’è¡£ï¼‰", date: "", note: "", checked: false },
];

// ---- Persistence ------------------------------------------------------
const KEY = "kinder-index:v1";
function loadState(){ return JSON.parse(localStorage.getItem(KEY)||"{}") }
function saveState(state){ localStorage.setItem(KEY, JSON.stringify(state)) }
let state = loadState();

// ---- Render ------------------------------------------------------------
const tbody = document.querySelector('#tbl tbody');
function render(){
  tbody.innerHTML='';
  const q=document.querySelector('#q').value.trim().toLowerCase();
  const onlyChecked=document.querySelector('#onlyChecked').checked;

  rows.forEach((r,i)=>{
    const rowState=state[r.name]||{checked:r.checked,note:r.note||''};
    if(q && !(r.name+ (r.date||'')+ (rowState.note||'')).toLowerCase().includes(q)) return;
    if(onlyChecked && !rowState.checked) return;

    const tr=document.createElement('tr');

    // name + note
    const td1=document.createElement('td');
    const noteDiv=document.createElement('div');
    noteDiv.className='note';
    noteDiv.innerHTML='å‚™è¨»ï¼š<span class="note-text">'+(rowState.note||'')+'</span>';
    const editBtn=document.createElement('button');
    editBtn.textContent='âœï¸ ç·¨è¼¯å‚™è¨»';
    editBtn.className='icon-btn';
    editBtn.onclick=()=>{
      const val=prompt('è¼¸å…¥å‚™è¨»', rowState.note||'');
      if(val!==null){ rowState.note=val; state[r.name]=rowState; saveState(state); render();

// === ä»¥é¦™æ¸¯æ™‚é–“æ¯”è¼ƒä¸¦å¥—ç”¨ 14/7/3/ä»Šæ—¥/éæœŸ åˆ†ç´šé«˜äº® ===
function hkToday(){
  // å–é¦™æ¸¯ç•¶åœ°çš„ã€Œä»Šå¤©ã€æ—¥æœŸï¼ˆå»æ™‚åˆ†ç§’ï¼‰
  const nowHK = new Date(new Date().toLocaleString('en-US', { timeZone:'Asia/Hong_Kong' }));
  return new Date(nowHK.getFullYear(), nowHK.getMonth(), nowHK.getDate());
}
function classifyTier(dt){
  if(!dt) return {cls:'', label:''};
  const today = hkToday();
  const end = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
  const diffDays = Math.ceil((end - today) / 86400000); // ä»¥æ—¥ç‚ºå–®ä½
  if(diffDays < 0) return {cls:'due-over', label:'å·²éæœŸ'};
  if(diffDays === 0) return {cls:'due-today', label:'ä»Šæ—¥æˆªæ­¢'};
  if(diffDays <= 3) return {cls:'due-3', label:`${diffDays}æ—¥å…§æˆªæ­¢`};
  if(diffDays <= 7) return {cls:'due-7', label:`${diffDays}æ—¥å…§æˆªæ­¢`};
  if(diffDays <= 14) return {cls:'due-14', label:`${diffDays}æ—¥å…§æˆªæ­¢`};
  return {cls:'', label:''};
}
function applyDeadlineTiers(){
  const rows = document.querySelectorAll('#tbl tbody tr');
  rows.forEach(tr=>{
    const cell = tr.children[1]; // æ—¥æœŸæ¬„
    if(!cell) return;
    const dateText = (cell.textContent||'').trim();
    const noteText = (tr.querySelector('.note')?.textContent||'').trim();
    const combined = `${dateText} ${noteText}`;

    // å…ˆæ¸…é™¤èˆŠ class
    cell.classList.remove('tier','due-14','due-7','due-3','due-today','due-over');
    cell.removeAttribute('data-due-label');

    // å…ˆå˜—è©¦ç”¨ parseDeadline åˆ¤æ–·æˆªæ­¢æ—¥
    let deadline = null;
    if(typeof parseDeadline === 'function'){
      deadline = parseDeadline(combined);
    }
    if(deadline){
      const {cls,label} = classifyTier(deadline);
      if(cls){ cell.classList.add('tier', cls); cell.setAttribute('data-due-label', label); return; }
    }

    // è‹¥æ²’æœ‰æˆªæ­¢æ—¥ï¼Œé€€è€Œåˆ¤æ–·æ˜¯å¦ã€Œæ¥å—æœŸå…§ã€
    if(typeof parseRange === 'function' && typeof inRangeToday === 'function'){
      const range = parseRange(dateText);
      if(inRangeToday(range)){
        cell.classList.add('tier','due-today');
        cell.setAttribute('data-due-label','æ¥å—æœŸå…§');
      }
    }
  });
}

applyDeadlineTiers();

// è‹¥è¡¨æ ¼å…§å®¹è®Šå‹•ï¼ˆæœå°‹/é‡ç¹ª/ç·¨è¼¯ï¼‰ï¼Œè‡ªå‹•é‡æ–°å¥—ç”¨
new MutationObserver(()=>{ applyDeadlineTiers(); })
  .observe(document.querySelector('#tbl tbody'), { childList:true, subtree:false });

// === å³æ™‚ç·¨è¼¯ & é¦™æ¸¯æ™‚é–“æ¯”è¼ƒé«˜äº® ===
const DATA_KEY = 'kinder-data:v1';
const getStore = () => JSON.parse(localStorage.getItem(DATA_KEY) || '{}');
const setStore = (obj) => localStorage.setItem(DATA_KEY, JSON.stringify(obj));

function enableEditing(){
  const data = getStore();
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
    const name = tr.querySelector('.name')?.textContent.trim() || '';
    // å‚™è¨»æ¬„ä½ï¼ˆè‹¥æ²’æœ‰å°±å»ºç«‹ä¸€å€‹ï¼‰
    let noteDiv = tr.querySelector('.note');
    if(!noteDiv){ noteDiv = document.createElement('div'); noteDiv.className='note'; noteDiv.textContent='å‚™è¨»ï¼š'; tr.children[0].appendChild(noteDiv); }
    noteDiv.contentEditable = 'true';
    noteDiv.addEventListener('blur', ()=>{
      const store = getStore();
      store[name] = store[name] || {};
      store[name].note = noteDiv.textContent.replace(/^å‚™è¨»ï¼š/,'').trim();
      setStore(store);
      highlightWithinRows();
    });

    // æ—¥æœŸæ¬„ä½å¯ç·¨è¼¯
    const dateCell = tr.children[1];
    if(dateCell){
      dateCell.contentEditable = 'true';
      dateCell.addEventListener('blur', ()=>{
        const store = getStore();
        store[name] = store[name] || {};
        store[name].date = dateCell.textContent.trim();
        setStore(store);
        highlightWithinRows();
      });
    }

    // è¼‰å…¥å·²å„²å­˜è³‡æ–™
    const s = data[name];
    if(s){
      if(s.note !== undefined) noteDiv.textContent = 'å‚™è¨»ï¼š' + s.note;
      if(s.date && dateCell) dateCell.textContent = s.date;
    }
  });
}

function highlightWithinRows(){
  document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
    const dateText = (tr.children[1]?.textContent || '').trim();
    const noteText = (tr.querySelector('.note')?.textContent || '').trim();
    const combined = dateText + ' ' + noteText; // åŒæ™‚è€ƒæ…®å‚™è¨»ä¸­çš„æ—¥æœŸ
    const range = parseRange(combined);
    const cell = tr.children[1];
    if(!cell) return;
    cell.classList.remove('within');
    if(inRangeToday(range)) cell.classList.add('within');
  });
}

// é¦–æ¬¡å¥—ç”¨
enableEditing();
highlightWithinRows();
// å…§å®¹æ”¹è®Šï¼ˆä¾‹å¦‚æœå°‹æˆ–é‡ç¹ªï¼‰å¾Œå†æ¬¡å¥—ç”¨
new MutationObserver(()=>{ enableEditing(); highlightWithinRows(); })
  .observe(document.querySelector('#tbl tbody'), { childList:true }); }
    };
    td1.innerHTML='<div class="name">'+r.name+'</div>';
    td1.appendChild(noteDiv); td1.appendChild(editBtn);

    // date + highlight
    const td2=document.createElement('td');
    td2.textContent=r.date||'â€”';
    if(r.date){
      const range=parseRange(r.date);
      if(inRangeToday(range)) td2.classList.add('within');
    }

    // status
    const td3=document.createElement('td');
    const label=document.createElement('label');
    label.className='status-pill '+(rowState.checked?'status-ok':'status-empty');
    const chk=document.createElement('input');
    chk.type='checkbox'; chk.className='check'; chk.checked=rowState.checked;
    chk.onchange=(e)=>{ rowState.checked=e.target.checked; state[r.name]=rowState; saveState(state); render(); };
    const text=document.createElement('span');
    text.textContent=rowState.checked?'âœ… å·²è™•ç†':'å¾…è™•ç†';
    label.appendChild(chk); label.appendChild(text);
    td3.appendChild(label);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tbody.appendChild(tr);
  });
}

// ---- Date Range Helper ------------------------------------------------
function digitsOnly(s){return s.replace(/[^0-9]/g,'')}
function readDate(part, fallbackYear){
  const yMatch=part.match(/(\d{4})å¹´/);
  const mMatch=part.match(/(\d{1,2})æœˆ/);
  const dMatch=part.match(/(\d{1,2})æ—¥/);
  if(!mMatch||!dMatch) return null;
  const y=yMatch?+yMatch[1]:fallbackYear||new Date().getFullYear();
  return new Date(y,(+mMatch[1])-1,+dMatch[1]);
}
function parseRange(text){
  if(!text) return null; const parts=text.split('è‡³');
  if(parts.length===2){
    const s=readDate(parts[0]);
    const e=readDate(parts[1], s?s.getFullYear():undefined);
    return s&&e?{start:s,end:e}:null;
  }
  return null;
}
function inRangeToday(range){
  if(!range) return false;
  const now=new Date(); const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  return today>=range.start && today<=range.end;
}

// ---- Controls ----------------------------------------------------------
document.querySelector('#q').addEventListener('input', render);
document.querySelector('#onlyChecked').addEventListener('change', render);
document.querySelector('#clearChecks').addEventListener('click',()=>{state={}; saveState(state); render();});

document.getElementById('updated').textContent=new Date().toLocaleString();

// ---- HK Clock ----------------------------------------------------------
function updateClock(){
  const now=new Date().toLocaleString('zh-Hant',{timeZone:'Asia/Hong_Kong'});
  document.getElementById('hkclock').textContent=now;
}
setInterval(updateClock,1000); updateClock();

// ---- Export CSV --------------------------------------------------------
function exportCsv(){
  const headers=['å¹¼ç¨šåœ’','æ¥å—ç”³è«‹æ—¥æœŸ / å‚™è¨»','Status'];
  const visible=Array.from(tbody.querySelectorAll('tr')).map(tr=>{
    const tds=tr.querySelectorAll('td');
    const name=tds[0].querySelector('.name').textContent.trim();
    const note=tds[0].querySelector('.note-text').textContent.trim();
    const date=tds[1].textContent.trim();
    const status=tds[2].querySelector('input').checked?'å·²è™•ç†':'å¾…è™•ç†';
    return [name,(date||'')+(note?` | å‚™è¨»:${note}`:''),status];
  });
  const lines=[headers,...visible].map(r=>r.map(x=>'"'+x.replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob=new Blob([lines],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='å¹¼ç¨šåœ’ç”³è«‹è¿½è¹¤.csv';
  a.click();
}
document.getElementById('exportCsv').addEventListener('click',exportCsv);

// initial render
render();
</script>
</body>
</html>
