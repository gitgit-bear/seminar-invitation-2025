<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¹¼ç¨šåœ’ç”³è«‹è¿½è¹¤ | Kindergarten Application Index</title>
  <style>
    :root{--bg:#0b1020;--card:#11162a;--muted:#8aa0b9;--text:#eaf2ff;--accent:#4da3ff;--ok:#27c084;--warn:#ffc857;--danger:#ff6a6a;--line:#1e2742}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0b1428);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:24px}
    .header{display:flex;gap:16px;align-items:end;flex-wrap:wrap}
    h1{margin:0;font-size:clamp(22px,3.2vw,32px);letter-spacing:.3px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .control{background:var(--card);border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:flex;align-items:center;gap:8px}
    input[type="text"]{background:transparent;border:none;outline:none;color:var(--text);min-width:220px}
    .btn{cursor:pointer;background:var(--accent);color:#001; border:none;padding:10px 14px;border-radius:12px;font-weight:600}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--line)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:4px;overflow:hidden;margin-top:16px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:rgba(17,22,42,.9);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--line);text-align:left;font-size:14px;padding:12px}
    tbody td{border-top:1px solid var(--line);padding:12px;vertical-align:top}
    tbody tr:hover{background:rgba(77,163,255,.06)}
    .name{font-weight:650}
    .status-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:13px}
    .status-ok{background:rgba(39,192,132,.15);border-color:rgba(39,192,132,.35)}
    .status-empty{background:rgba(138,160,185,.08)}
    .check{accent-color:var(--ok);width:18px;height:18px}
    .badge{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .note{color:var(--muted);font-size:13px}
    footer{margin:18px 0;color:var(--muted);font-size:13px}

    /* === Deadline highlights === */
    .due{position:relative}
    .due::after{content:attr(data-due-label);margin-left:8px;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--line)}
    .due-over{background:rgba(255,106,106,.16)}
    .due-over::after{background:rgba(255,106,106,.35);color:#330202}
    .due-today{background:rgba(77,163,255,.18)}
    .due-today::after{background:rgba(77,163,255,.35);color:#001933}
    .due-soon{background:rgba(255,200,87,.12)}
    .due-soon::after{background:rgba(255,200,87,.25);color:#2b1e00}

    .note-actions{display:inline-flex;gap:6px;margin-left:6px}
    .icon-btn{cursor:pointer;border:1px solid var(--line);background:transparent;border-radius:8px;padding:2px 6px;font-size:12px;color:var(--muted)}
    .icon-btn:hover{border-color:var(--accent);color:var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>å¹¼ç¨šåœ’ç”³è«‹è¿½è¹¤è¡¨ <span class="muted">(Kindergarten Application Index)</span></h1>
      <span class="badge">æœ€å¾Œæ›´æ–°ï¼š<span id="updated"></span></span>
    </div>

    <div class="controls">
      <label class="control" title="æœå°‹å­¸æ ¡æˆ–æ—¥æœŸ">
        ğŸ” <input id="q" type="text" placeholder="æœå°‹å­¸æ ¡ / æ—¥æœŸ / é—œéµå­—" />
      </label>
      <label class="control">
        <input id="onlyChecked" type="checkbox" /> åªé¡¯ç¤º âœ… å·²è™•ç†
      </label>
      <button class="btn" id="exportCsv">åŒ¯å‡º CSV</button>
      <button class="btn secondary" id="clearChecks">æ¸…é™¤æœ¬æ©Ÿ âœ… è¨˜éŒ„</button>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:44%">å¹¼ç¨šåœ’</th>
            <th style="width:42%">æ¥å—ç”³è«‹æ—¥æœŸ / å‚™è¨»</th>
            <th style="width:14%">Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>æç¤ºï¼šâœ”ï¸ åˆ‡æ› Status æœƒå„²å­˜æ–¼ç€è¦½å™¨ <span class="badge">localStorage</span>ï¼Œä¸æœƒä¸Šå‚³è³‡æ–™ã€‚</footer>
  </div>

<script>
// ---- Data --------------------------------------------------------------
const rows = [
  { name: "åº·å‚‘ä¸­è‹±æ–‡å¹¼ç¨šåœ’", date: "2025å¹´6æœˆ9æ—¥è‡³2025å¹´9æœˆ15æ—¥ä¸‹åˆ5æ™‚æ­£", note: "", checked: true },
  { name: "ç¶ æ¥Šå¹¼ç¨šåœ’æš¨å¹¼å…’åœ’", date: "2025å¹´9æœˆ13æ—¥è‡³9æœˆ20æ—¥ï¼ˆéƒµå¯„ï¼‰", note: "", checked: false },
  { name: "å¿ƒæ€¡å¤©åœ°åœ‹éš›å¹¼å…’åœ’æš¨å¹¼ç¨š", date: "2025å¹´8æœˆè‡³10æœˆ12æ—¥ï¼ˆéƒµå¯„ï¼‰", note: "14/8âœ…", checked: true },
  { name: "ç¶­å¤šåˆ©äºï¼ˆæµ·ä¹‹æˆ€ï¼‰åœ‹éš›å¹¼å…’åœ’", date: "2025å¹´9æœˆ15æ—¥è‡³2025å¹´12æœˆ15æ—¥ï¼ˆæ˜ŸæœŸä¸€ï¼‰ä¸‹åˆ5æ™‚", note: "", checked: false },
  { name: "é’è¡£å­¸ä¹‹åœ’", date: "å°‡æ–¼2026å¹´1æœˆå…¬ä½ˆ", note: "", checked: false },
  { name: "ä¹é¾å¡˜è¿¦å—", date: "2025å¹´9æœˆ15æ—¥è‡³10æœˆ19æ—¥", note: "", checked: false },
  { name: "è¿¦å—å¹¼ç¨šåœ’ï¼ˆæµ·æ¿±èŠ±åœ’ï¼‰", date: "2025å¹´9æœˆ15æ—¥è‡³10æœˆ19æ—¥", note: "", checked: false },
  { name: "è¿¦å—å¹¼ç¨šåœ’(çª©æ‰“è€é“)", date: "2025å¹´9æœˆ15æ—¥è‡³10æœˆ19æ—¥", note: "", checked: false },
  { name: "St Catherine åœ‹éš›è‹±æ–‡å¹¼ç¨šåœ’", date: "", note: "", checked: false },
  { name: "å¾·èƒåœ‹éš›å¹¼å…’åœ’", date: "", note: "4/9âœ…", checked: true },
  { name: "æ˜æ…§åœ‹éš›å¹¼ç¨šåœ’", date: "", note: "12/8âœ…", checked: true },
  { name: "å“æ€è‹±æ–‡å­¸æ ¡æš¨å¹¼ç¨šåœ’", date: "2025å¹´10æœˆ27æ—¥è‡³11æœˆ1æ—¥", note: "", checked: false },
  { name: "åŠé³´å¹¼ç¨šåœ’", date: "2026å¹´1æœˆ7æ—¥ä¸Šåˆ9æ™‚è‡³1æœˆ14æ—¥ä¸‹åˆ5æ™‚", note: "", checked: false },
  { name: "é›…å£«åœ–åœ‹éš›å¹¼ç¨šåœ’", date: "", note: "3/9âœ…", checked: true },
  { name: "å•Ÿæ€å¹¼ç¨šåœ’ï¼ˆé’è¡£ï¼‰", date: "", note: "", checked: false },
];

// ---- Deadline parsing (ä¸­æ–‡æ—¥æœŸ + å‚™è¨»ä¸­çš„ dd/mm) -------------------------
const SOON_DAYS = 7;      // 7æ—¥å…§
const TODAY_HOURS = 24;   // 24å°æ™‚å…§

function parseTimePart(str){
  // ä¸Šåˆ9æ™‚ / ä¸‹åˆ5æ™‚æ­£
  const m = str.match(/(ä¸Šåˆ|ä¸‹åˆ)?\s*(\d{1,2})\s*æ™‚/);
  if(!m) return 17;
  let h = Number(m[2]);
  if(m[1]==='ä¸‹åˆ' && h<12) h += 12;
  if(m[1]==='ä¸Šåˆ' && h===12) h = 0;
  return h;
}

function parseDeadline(text){
  // å¾ã€Œæ¥å—ç”³è«‹æ—¥æœŸã€æˆ–ã€Œå‚™è¨»ã€è£¡æŠ“æœ€å¾Œä¸€å€‹æ—¥æœŸç•¶æˆªæ­¢
  if(!text) return null;
  const results = [];
  const hour = parseTimePart(text);

  // å®Œæ•´ YYYYå¹´MæœˆDæ—¥
  [...text.matchAll(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/g)]
    .forEach(m => results.push(new Date(+m[1], +m[2]-1, +m[3], hour)));

  // åªæœ‰ MæœˆDæ—¥ï¼ˆæ¨å®šä»Šå¹´ï¼›è‹¥å·²éå‰‡æ˜å¹´ï¼‰
  const now = new Date();
  [...text.matchAll(/(\d{1,2})æœˆ(\d{1,2})æ—¥/g)]
    .forEach(m => {
      let y = now.getFullYear();
      let dt = new Date(y, +m[1]-1, +m[2], hour);
      if(dt < now) dt = new Date(y+1, +m[1]-1, +m[2], hour);
      results.push(dt);
    });

  // å‚™è¨»ä¸­çš„ 4/9, 12/8ï¼ˆdd/mmï¼‰
  [...text.matchAll(/\b(\d{1,2})\/(\d{1,2})\b/g)]
    .forEach(m => {
      const d = +m[1], mm = +m[2];
      const y = now.getFullYear();
      results.push(new Date(y, mm-1, d, 17));
    });

  if(!results.length) return null;
  results.sort((a,b)=>a-b);
  return results[results.length-1]; // å–æœ€å¾Œä¸€å€‹ï¼ˆé€šå¸¸æ˜¯æˆªæ­¢ï¼‰
}

function deadlineClass(dt){
  if(!dt) return {cls:'', label:''};
  const now = new Date();
  const diffMs = dt - now;
  const diffHours = diffMs / 36e5;
  const diffDays = diffMs / 864e5;
  if(diffHours <= 0) return {cls:'due-over',  label:'å·²éæœŸ'};
  if(diffHours <= TODAY_HOURS) return {cls:'due-today', label:'ä»Šæ—¥æˆªæ­¢'};
  if(diffDays  <= SOON_DAYS)  return {cls:'due-soon',  label:`${Math.ceil(diffDays)}æ—¥å…§æˆªæ­¢`};
  return {cls:'', label:''};
}

// ---- Persistence (ç‹€æ…‹ + å‚™è¨») -----------------------------------------
const KEY = "kinder-index:v1";         // å‹¾é¸ç‹€æ…‹
const NOTES_KEY = "kinder-notes:v1";   // è‡ªè¨‚å‚™è¨»
const saved = JSON.parse(localStorage.getItem(KEY) || "{}");
const savedNotes = JSON.parse(localStorage.getItem(NOTES_KEY) || "{}");
const getSaved = (name)=> saved[name];
const setSaved = (name,val)=>{ saved[name]=!!val; localStorage.setItem(KEY, JSON.stringify(saved)); };
const getNote  = (name, fallback)=> savedNotes[name] ?? fallback ?? "";
const setNote  = (name,val)=>{ savedNotes[name]=val||""; localStorage.setItem(NOTES_KEY, JSON.stringify(savedNotes)); };
const clearSaved = ()=>{ localStorage.removeItem(KEY); localStorage.removeItem(NOTES_KEY); location.reload(); };

// ---- Render ------------------------------------------------------------
const tbody = document.querySelector('#tbl tbody');
function render(){
  const q = document.querySelector('#q').value.trim().toLowerCase();
  const onlyChecked = document.querySelector('#onlyChecked').checked;
  tbody.innerHTML = '';

  rows.forEach(r => {
    const persisted = getSaved(r.name);
    const isChecked = typeof persisted === 'boolean' ? persisted : r.checked;

    const userNote = getNote(r.name, r.note);
    const textBlob = (r.name + ' ' + (r.date||'') + ' ' + (userNote||'')).toLowerCase();
    if(q && !textBlob.includes(q)) return;
    if(onlyChecked && !isChecked) return;

    const tr = document.createElement('tr');

    // col 1: name + note (+ edit)
    const td1 = document.createElement('td');
    const noteHtml = userNote ? `<div class="note">å‚™è¨»ï¼š<span class="note-text">${userNote}</span></div>` : `<div class="note">å‚™è¨»ï¼š<span class="note-text"></span></div>`;
    td1.innerHTML = `<div class="name">${r.name}</div>${noteHtml}`;
    const actions = document.createElement('div');
    actions.className = 'note-actions';
    const btnEdit = document.createElement('button');
    btnEdit.className = 'icon-btn';
    btnEdit.textContent = 'âœï¸ ç·¨è¼¯å‚™è¨»';
    btnEdit.addEventListener('click', ()=>{
      const current = getNote(r.name, r.note);
      const val = prompt('è¼¸å…¥å‚™è¨»ï¼ˆæ”¯æ´ 4/9 é€™é¡æ—¥æœŸï¼Œæœƒä¸€èµ·åˆ¤æ–·æˆªæ­¢ï¼‰', current || '');
      if(val === null) return;
      setNote(r.name, val);
      render();
    });
    actions.appendChild(btnEdit);
    td1.appendChild(actions);

    // col 2: date + highlight
    const td2 = document.createElement('td');
    if(r.date || userNote){
      const deadline = parseDeadline((r.date||'') + ' ' + (userNote||''));
      const {cls,label} = deadlineClass(deadline);
      td2.className = cls ? `due ${cls}` : '';
      if(cls) td2.setAttribute('data-due-label', label);
      td2.textContent = r.date || 'â€”';
    }else{
      td2.innerHTML = '<span class="muted">â€”</span>';
    }

    // col 3: status
    const td3 = document.createElement('td');
    const label = document.createElement('label');
    label.className = 'status-pill ' + (isChecked ? 'status-ok' : 'status-empty');
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.className = 'check';
    chk.checked = isChecked;
    chk.addEventListener('change', e => {
      setSaved(r.name, e.target.checked);
      label.className = 'status-pill ' + (e.target.checked ? 'status-ok' : 'status-empty');
      text.textContent = e.target.checked ? 'âœ… å·²è™•ç†' : 'å¾…è™•ç†';
    });
    const text = document.createElement('span');
    text.textContent = isChecked ? 'âœ… å·²è™•ç†' : 'å¾…è™•ç†';
    label.appendChild(chk); label.appendChild(text);
    td3.appendChild(label);

    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tbody.appendChild(tr);
  });
}

render();

// ---- Controls ----------------------------------------------------------
document.querySelector('#q').addEventListener('input', render);
document.querySelector('#onlyChecked').addEventListener('change', render);
document.querySelector('#clearChecks').addEventListener('click', clearSaved);

document.getElementById('updated').textContent = new Date().toLocaleString();

// ---- Export CSV --------------------------------------------------------
function exportCsv(){
  const headers = ['å¹¼ç¨šåœ’','æ¥å—ç”³è«‹æ—¥æœŸ / å‚™è¨»','Status'];
  const visible = Array.from(tbody.querySelectorAll('tr')).map(tr => {
    const tds = tr.querySelectorAll('td');
    const name = tds[0].querySelector('.name').textContent.trim();
    const note = (tds[0].querySelector('.note-text')?.textContent || '').trim();
    const date = tds[1].textContent.trim();
    const status = tds[2].querySelector('input').checked ? 'å·²è™•ç†' : 'å¾…è™•ç†';
    return [name, (date || '') + (note? ` | å‚™è¨»:${note}`:''), status];
  });
  const lines = [headers, ...visible]
    .map(row => row.map(x => '"' + (x || '').replaceAll('"','""') + '"').join(','))
    .join('\n');
  const blob = new Blob([lines], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'å¹¼ç¨šåœ’ç”³è«‹è¿½è¹¤.csv';
  a.click();
}
document.getElementById('exportCsv').addEventListener('click', exportCsv);
</script>
</body>
</html>
